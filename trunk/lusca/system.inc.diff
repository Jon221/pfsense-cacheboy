--- /etc/inc/system.inc.orig	2010-03-21 20:19:13.627752000 +0800
+++ /etc/inc/system.inc	2010-03-21 20:26:46.000000000 +0800
@@ -1113,6 +1113,8 @@
 function system_halt() {
 	global $g;
 
+	mwexec("/usr/local/etc/rc.d/squid.sh stop");
+
 	system_reboot_cleanup();
 
 	mwexec("nohup /etc/rc.halt > /dev/null 2>&1 &");
@@ -1121,6 +1123,8 @@
 function system_reboot() {
 	global $g;
 
+	mwexec("/usr/local/etc/rc.d/squid.sh stop");
+
 	system_reboot_cleanup();
 
 	mwexec("nohup /etc/rc.reboot > /dev/null 2>&1 &");
@@ -1129,6 +1133,8 @@
 function system_reboot_sync() {
 	global $g;
 
+	mwexec("/usr/local/etc/rc.d/squid.sh stop");
+
 	system_reboot_cleanup();
 
 	mwexec("/etc/rc.reboot > /dev/null 2>&1");
